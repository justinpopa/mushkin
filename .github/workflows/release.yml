name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a draft GitHub release'
        required: false
        default: true
        type: boolean
  workflow_call:
    inputs:
      version:
        required: true
        type: string

jobs:
  version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get version from tag or input
        id: version
        run: |
          if [[ -n "${{ inputs.version }}" ]]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            echo "version=0.0.0-dev" >> $GITHUB_OUTPUT
          fi

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install cmake ninja pcre luajit sqlite openssl
          pip3 install aqtinstall --break-system-packages

      - name: Cache Qt Static
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ~/.cache/mushkin/Qt-static
          key: qt-static-6.9.3-macos-${{ runner.arch }}-v4

      - name: Build Static Binary
        run: ./scripts/build-macos-static.sh

      - name: Package
        run: |
          mkdir -p package
          cp build-static/mushkin package/
          cp README.md LICENSE package/ 2>/dev/null || true
          cd package
          zip -r ../mushkin-${{ needs.version.outputs.version }}-macos-${{ runner.arch }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ runner.arch }}
          path: mushkin-${{ needs.version.outputs.version }}-macos-*.zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Free up disk space
        run: |
          # Remove large unused tools to free ~30GB+
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /opt/hostedtoolcache/go
          sudo rm -rf /opt/hostedtoolcache/node
          sudo rm -rf /opt/hostedtoolcache/Python
          sudo rm -rf /opt/hostedtoolcache/Ruby
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/.ghcup
          sudo apt-get clean
          df -h

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build pkg-config \
            libpcre3-dev libsqlite3-dev luajit libluajit-5.1-dev \
            libssl-dev zlib1g-dev libgl1-mesa-dev libglu1-mesa-dev \
            libxkbcommon-dev libxcb1-dev libxcb-cursor-dev libxcb-icccm4-dev \
            libxcb-keysyms1-dev libxcb-shape0-dev libxcb-xfixes0-dev \
            libxcb-sync-dev libxcb-randr0-dev libxcb-render-util0-dev \
            libxcb-image0-dev libxcb-glx0-dev libxcb-shm0-dev \
            libfontconfig1-dev libfreetype6-dev libx11-dev libx11-xcb-dev \
            libxext-dev libxfixes-dev libxi-dev libxrender-dev \
            libatspi2.0-dev libglib2.0-dev \
            libpulse-dev libasound2-dev libpipewire-0.3-dev
          pip3 install aqtinstall

      - name: Cache Qt Static
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ~/.cache/mushkin/Qt-static
          key: qt-static-6.9.3-linux-x64-v4

      - name: Build Static Binary
        run: ./scripts/build-linux-static.sh

      - name: Package
        run: |
          mkdir -p package/mushkin
          cp build-static/mushkin package/mushkin/
          cp README.md LICENSE package/mushkin/ 2>/dev/null || true
          cd package
          tar -czf ../mushkin-${{ needs.version.outputs.version }}-linux-x64.tar.gz mushkin

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: mushkin-${{ needs.version.outputs.version }}-linux-x64.tar.gz

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Enable Long Paths
        run: |
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem' -Name 'LongPathsEnabled' -Value 1 -Type DWord

      - name: Install dependencies
        run: |
          choco install ninja -y
          pip install aqtinstall
          vcpkg install pcre:x64-windows luajit:x64-windows sqlite3:x64-windows openssl:x64-windows zlib:x64-windows

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Cache Qt Static
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: C:/Users/runneradmin/AppData/Local/mushkin/Qt-static
          key: qt-static-6.9.3-windows-x64-v6

      - name: Build Static Binary
        run: |
          $env:VCPKG_ROOT = "C:\vcpkg"
          .\scripts\build-windows-static.ps1

      - name: Package
        run: |
          mkdir package\mushkin
          copy build-static\mushkin.exe package\mushkin\
          copy README.md package\mushkin\ 2>$null
          copy LICENSE package\mushkin\ 2>$null

          # Copy vcpkg DLLs
          $vcpkgBin = "C:\vcpkg\installed\x64-windows\bin"
          if (Test-Path $vcpkgBin) {
            copy "$vcpkgBin\*.dll" package\mushkin\ 2>$null
          }

          cd package
          7z a ..\mushkin-${{ needs.version.outputs.version }}-windows-x64.zip mushkin

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: mushkin-${{ needs.version.outputs.version }}-windows-x64.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [version, build-macos, build-linux, build-windows]
    # Only create release for tags or when explicitly requested via manual dispatch
    if: startsWith(github.ref, 'refs/tags/') || inputs.create_release == true || inputs.version != ''
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List Artifacts
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', needs.version.outputs.version) }}
          name: Mushkin ${{ needs.version.outputs.version }}
          body: |
            ## Downloads

            | Platform | File | Contents |
            |----------|------|----------|
            | **Windows x64** | `mushkin-${{ needs.version.outputs.version }}-windows-x64.zip` | Self-contained (exe + DLLs) |
            | **Linux x64** | `mushkin-${{ needs.version.outputs.version }}-linux-x64.tar.gz` | Binary (requires system deps) |
            | **macOS** | `mushkin-${{ needs.version.outputs.version }}-macos-*.zip` | Binary (requires Homebrew deps) |

            ## Installation

            ### Windows
            1. Extract the ZIP file
            2. Run `mushkin.exe`

            All required DLLs are included - no additional installation needed.

            ### Linux
            First install dependencies:
            ```bash
            sudo apt install libpcre3 libluajit-5.1-2 libsqlite3-0 libssl3 zlib1g
            ```
            Then:
            ```bash
            tar -xzf mushkin-*.tar.gz
            ./mushkin/mushkin
            ```

            ### macOS
            First install dependencies:
            ```bash
            brew install pcre luajit sqlite openssl
            ```
            Then:
            1. Extract the ZIP file
            2. Run `mushkin`
            3. First run: Right-click â†’ Open (to bypass Gatekeeper)
          files: |
            artifacts/**/*
